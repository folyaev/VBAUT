# Локальный ассистент визуального брифа

Инструмент для сценаристов и редакторов: сегментирует текст, помогает подобрать визуал и поисковые запросы, сохраняет историю правок и экспортирует датасет для обучения.

## Ключевые возможности

- Сегментация сценария по блокам (intro/news/ad/selfad/outro) в двух режимах: ручной и авто (best‑effort).
- Группировка сегментов по темам/разделам.
- AI Help по одной теме/сегменту за раз, чтобы не ждать весь документ.
- Визуальные решения (тип визуала, формат, приоритет, длительность).
- Поисковые запросы + кнопки Google/Яндекс, с раскрываемым блоком.
- Экспорт в JSONL и Markdown для обучения и обмена.
- История версий и событий в `data/`.

## Быстрый старт

Требуется Node.js 18+ и любой сервер с OpenAI‑compatible API (llama.cpp, vLLM, LM Studio server, Ollama + openai wrapper и т.п.).

```powershell
npm install
npm run dev
```

Запустятся два dev‑сервера: backend и frontend.

## Запуск по отдельности

### Бэкенд

```powershell
cd backend
npm install
npm run dev
```

### Фронтенд

```powershell
cd frontend
npm install
npm run dev
```

## Настройки LLM

Переменные окружения (необязательные):

- `LLAMA_BASE_URL` — адрес сервера llama.cpp (по умолчанию `http://127.0.0.1:8080`).
- `LLAMA_MODEL` — имя модели (если пусто, берётся первая из `/v1/models`).
- `LLAMA_MAX_TOKENS` — лимит токенов ответа.
- `LLM_DECISION_BATCH` — размер батча при генерации решений.
- `LLM_FETCH_RETRIES` — число повторов при сбое `fetch`.
- `LLM_FETCH_RETRY_DELAY_MS` — базовая задержка между ретраями.

Пример:

```powershell
set LLAMA_BASE_URL=http://127.0.0.1:8080
set LLAMA_MAX_TOKENS=2048
set LLM_DECISION_BATCH=6
```

## Как пользоваться

1) Вставьте текст сценария.
2) Нажмите «Сегментировать» — создадутся только сегменты.
3) В нужной теме нажимайте «AI Help», чтобы получать визуал и поиск по одному сегменту.
4) При необходимости правьте вручную и сохраняйте.
5) Экспортируйте JSONL/MD для обучения.

## Экспорт

- **JSONL** — по одному сегменту в строке, формат `messages` (system/user/assistant + meta). Схема фиксирована и не плавает между версиями:

```json
{
  "messages": [
    { "role": "system", "content": "..." },
    { "role": "user", "content": "{...segment...}" },
    { "role": "assistant", "content": "{...decisions...}" }
  ],
  "meta": {
    "doc_id": "doc_...",
    "segment_id": "news_01",
    "block_type": "news",
    "section_id": "section_01",
    "section_title": "Интро",
    "section_index": 1
  }
}
```
- **MD** — удобный для чтения экспорт с разделами и блоками.

## Данные

Все документы и версии сохраняются в `data/`:

- `document.json` — исходный текст
- `segments.json` — сегменты
- `decisions.json` — визуал + поиск
- `events.jsonl` — история действий

## Подводные камни

1) **Авто‑сегментация — best‑effort.** Для сценарного монтажа важно, чтобы интро/новости/реклама были выверены вручную. Система даёт черновик, финальная раскладка — за редактором.
2) **Визуал не равен правде.** Модель может предлагать «красивые» визуалы, но не факт‑чекит. Режиссёр монтажа обязан перепроверять соответствие фактам/таймкоду.
3) **Темп и ритм важнее средней длительности.** Авто‑оценка длительности условна; под реальный ритм нужно подгонять вручную.
4) **Стабильность LLM‑сервера.** Большие документы/контекст легко ломают генерацию. Лучше работать по одному сегменту (AI Help) и контролировать батчи.
5) **Схемы данных — дисциплина.** Для обучения (LoRA/FT) критично держать единую JSONL‑схему, иначе датасет превращается в зоопарк.

## Надёжность данных

- **Автосейв результатов AI‑операций:** генерация сегментов и AI Help сразу пишут версии.
- **Версионирование:** каждый `segments.json` и `decisions.json` сохраняется как новая версия.
- **События:** `events.jsonl` фиксирует все ключевые действия.
- **Восстановление:** можно вернуть любую версию из `data/` вручную (или сделать UI‑восстановление в будущем).
- **Ручные правки:** сохраняются по кнопке «Сохранить».

## TODO

### Приоритетные функции

- ⏺️ Добавить генерацию кнопки поиска для определенных материалов на определенных сайтах, например: «квадратные картинки высокого качества на Яндексе» или «новостные заголовки из рекомендуемых источников».
- ⏺️ Добавить интеграцию NotionHeadless бота, чтобы он автоматически подтягивал сценарий по указанной ссылке.
- ⏺️ Добавить проверку наличия блоков и добавления только новых (аналог механики из NotionHeadless).
- ⏺️ Добавить генерацию поисковых запросов на английском.
- ⏺️ Добавить более точную систему расчета длительности (например, по слогам, а не по словам).
- ⏺️ Добавить разделение на блоки выделением и overlay‑нажатием (аналог «Спросить ChatGPT» в браузере).
- ⏺️ Добавить автоматическую конвертацию полученных ссылок в превью (аналог Embed link в Notion): ссылки убираются из цитаты и выносятся в отдельный блок.
- ⏺️ Добавить экспорт в XML сценария, через маркеры, с таймкодами (аналог функции в таймкод‑ПО).
- ⏺️ Добавить переключение моделей на платные OpenAI аналоги по API

### Идеи для развития от Codex

- Автоматическое определение типа блока на основе содержания.
- Режим «строгого стиля» для визуала (например, только архив/карта/инфографика).
- Генерация альтернативных вариантов визуала (top‑3 на сегмент).
- Пакетная генерация решений по фильтру (например, только intro/outro).
- Гибкие шаблоны экспорта (JSONL под конкретные датасеты).
- Локальный словарь стоп‑слов и «персональных имён» для точных запросов.
- Авто‑подсказки к ключевым словам (расширение запросов).
- «Переразбивка» сегмента на под‑блоки с сохранением истории.
- Мягкие предупреждения о слишком длинных цитатах.
- Резервные профили LLM (например, 14B/7B) и быстрый переключатель.
- Генерация «таймлайн‑режима» с визуальной дорожкой и длительностями.
- Быстрый режим «обновить только визуал» или «обновить только поиск».
- Источники доверия: пометки «нужен факт‑чек» и «ссылка обязательна».
- Поддержка пользовательских словарей проектов (бренды, персоны, стоп‑слова).
- Авто‑подстановка визуала из медиатеки/архива по ключевым словам.
- Импорт сценариев из DOCX/Google Docs/Notion (ручной или по ссылке).
- Скрипт‑валидатор: предупреждения о пустых блоках, дубликатах, слишком коротких сегментах.
- Коллаборация: режим комментариев и отметки «готово/на проверке».
- Экспорт в CSV/TSV для монтажных таблиц.
- Персональные шаблоны сегментов (пресеты для intro/news/ad).
- Режим «пересборка структуры»: объединить/разделить сегменты с диффом.
- Локальная индексация прошлых сценариев для реюза и подсказок.

## Лицензия

MIT (можно заменить на свою).
